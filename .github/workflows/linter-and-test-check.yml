name: lint

on: 
  push:

jobs:
  flake8:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - run: python -m pip install poetry
      - run: poetry install
      - run: poetry run flake8 gendiff
      - run: poetry run pytest
      # - name: Test coverage
      #   uses: paambaati/codeclimate-action@v3.2.0
      #   if: github.ref_name == 'main'
      #   env:
      #     CC_TEST_REPORTER_ID: ${{ secrets.CC_TEST_REPORTER_ID }}
      #   with:
      #     coverageCommand: poetry run pytest --cov=gendiff.scripts
      #     debug: true

      - name: Run linter and pytest
        run: |
          make check
      - name: Create reporter
        run: |
          curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
          chmod +x ./cc-test-reporter
          ./cc-test-reporter before-build
      - name: Test and Report coverage
        run: |
          poetry run coverage run -m pytest
          poetry run coverage lcov -o coverage/lcov.info
      - name: Sending Reporter
        env:
          GITHUB_TOKEN: ${{ secrets.Coverage }} 
        run: |
          ./cc-test-reporter after-build -r "$GITHUB_TOKEN" -t lcov
